generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////////
// CORE IDENTITY & ORGANIZATION
//////////////////////////////////////////////////////

model Organization {
  id                    String   @id @default(uuid())
  name                  String
  type                  OrgType
  status                OrgStatus @default(active)
  createdAt             DateTime @default(now())
  
  // Stripe subscription fields
  stripeCustomerId      String?  @unique
  stripeSubscriptionId  String?  @unique
  pricingTier           String?
  subscriptionStatus    SubscriptionStatus @default(inactive)
  subscriptionStartedAt DateTime?
  subscriptionEndsAt    DateTime?
  
  // Termination & Grace Period
  gracePeriodEndsAt     DateTime?
  isReadOnlyMode        Boolean  @default(false)
  
  // Pricing Controls
  employeeCountAtRenewal Int?
  contractTermYears     Int?     @default(1)
  lockedDiscountRate    Float?
  lastRenewalPrice      Float?
  
  // SLA Tracking
  slaCreditsOwed        Float?   @default(0)

  users          User[]
  employees      Employee[]
  crews          Crew[]
  incidents      Incident[]
  audits         AuditCase[]
  assets         Asset[]
  policies       InsurancePolicy[]
  uptimeMetrics  UptimeMetric[]
  usageMetrics   UsageMetric[]
}

enum SubscriptionStatus {
  active
  inactive
  canceled
  past_due
  trialing
}

enum OrgType {
  railroad
  contractor
  emergency
  municipality
}

enum OrgStatus {
  active
  inactive
}

model User {
  id             String   @id @default(uuid())
  organizationId String?
  email          String   @unique
  password       String
  name           String?
  role           UserRole
  status         UserStatus @default(active)
  createdAt      DateTime @default(now())
  emailVerified  DateTime?

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  accounts     Account[]
  sessions     Session[]
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationRequest {
  id         String   @id @default(uuid())
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())

  @@unique([identifier, token])
}

enum UserRole {
  admin
  safety
  dispatcher
  supervisor
  executive
}

enum UserStatus {
  active
  disabled
}

//////////////////////////////////////////////////////
// EMPLOYEES (FIELD PERSONNEL â€“ NOT USERS)
//////////////////////////////////////////////////////

model Employee {
  id             String   @id @default(uuid())
  organizationId String
  firstName      String
  lastName       String
  tradeRole      String
  photoMediaId   String?
  status         EmployeeStatus @default(active)
  createdAt      DateTime @default(now())

  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  certifications      Certification[]
  crewMembers         CrewMember[]
  fieldLogs           FieldLog[]
  incidents           IncidentEmployee[]
  jhaAcknowledgments  JHAAcknowledgment[]
}

enum EmployeeStatus {
  active
  inactive
}

//////////////////////////////////////////////////////
// CREWS
//////////////////////////////////////////////////////

model Crew {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  members      CrewMember[]
}

model CrewMember {
  crewId     String
  employeeId String

  crew     Crew     @relation(fields: [crewId], references: [id], onDelete: Restrict)
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Restrict)

  @@id([crewId, employeeId])
}

//////////////////////////////////////////////////////
// CERTIFICATIONS & QR VERIFICATION
//////////////////////////////////////////////////////

model Certification {
  id                 String   @id @default(uuid())
  employeeId         String
  certificationType  String
  issuingAuthority   String
  issueDate          DateTime
  expirationDate     DateTime
  status             CertificationStatus
  certificateMediaId String?
  createdByUserId    String
  createdAt          DateTime @default(now())
  
  // Correction chain fields
  isCorrected        Boolean  @default(false)
  correctedById      String?  // References the corrected certification
  correctionReason   String?
  correctedAt        DateTime?
  correctedByUserId  String?

  employee       Employee              @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  qrTokens       VerificationToken[]
  correctedBy    Certification?        @relation("CorrectionChain", fields: [correctedById], references: [id], onDelete: Restrict)
  corrections    Certification[]       @relation("CorrectionChain")
}

enum CertificationStatus {
  valid
  expiring
  expired
  revoked
}

model VerificationToken {
  id              String   @id @default(uuid())
  certificationId String
  tokenHash       String   @unique
  status          TokenStatus @default(active)
  createdAt       DateTime @default(now())

  certification Certification     @relation(fields: [certificationId], references: [id], onDelete: Restrict)
  scans          VerificationEvent[]
}

enum TokenStatus {
  active
  revoked
}

model VerificationEvent {
  id                  String   @id @default(uuid())
  verificationTokenId String
  scannedAt           DateTime @default(now())
  locationId          String?
  result              VerificationResult

  token    VerificationToken @relation(fields: [verificationTokenId], references: [id], onDelete: Restrict)
  location Location?         @relation(fields: [locationId], references: [id])
}

enum VerificationResult {
  valid
  expired
  revoked
}

//////////////////////////////////////////////////////
// EVIDENCE & IMMUTABLE LEDGER
//////////////////////////////////////////////////////

model EvidenceNode {
  id          String   @id @default(uuid())
  entityType  String
  entityId    String
  actorType   ActorType
  actorId     String
  timestamp   DateTime @default(now())
  locationId  String?

  ledgerEntries       ImmutableEventLedger[]
  auditEvidenceLinks  AuditEvidenceLink[]
}

enum ActorType {
  user
  employee
  system
}

model ImmutableEventLedger {
  id             String   @id @default(uuid())
  evidenceNodeId String
  eventType      String
  payload        Json
  createdAt      DateTime @default(now())

  evidenceNode EvidenceNode @relation(fields: [evidenceNodeId], references: [id], onDelete: Restrict)
}

//////////////////////////////////////////////////////
// SAFETY & COMPLIANCE
//////////////////////////////////////////////////////

model JobHazardAnalysis {
  id             String   @id @default(uuid())
  organizationId String
  workType       String
  locationId     String
  weather        Json
  status         JHAStatus
  createdAt      DateTime @default(now())

  acknowledgments JHAAcknowledgment[]
}

enum JHAStatus {
  draft
  active
  closed
}

model JHAAcknowledgment {
  jhaId           String
  employeeId      String
  acknowledgedAt  DateTime @default(now())

  jha      JobHazardAnalysis @relation(fields: [jhaId], references: [id], onDelete: Restrict)
  employee Employee         @relation(fields: [employeeId], references: [id], onDelete: Restrict)

  @@id([jhaId, employeeId])
}

model AuditCase {
  id             String   @id @default(uuid())
  organizationId String
  auditType      AuditType
  status         AuditStatus
  createdAt      DateTime @default(now())

  organization  Organization        @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  evidenceLinks AuditEvidenceLink[]
}

enum AuditType {
  FRA
  OSHA
  internal
}

enum AuditStatus {
  open
  closed
}

model AuditEvidenceLink {
  auditCaseId    String
  evidenceNodeId String

  auditCase   AuditCase   @relation(fields: [auditCaseId], references: [id], onDelete: Restrict)
  evidenceNode EvidenceNode @relation(fields: [evidenceNodeId], references: [id], onDelete: Restrict)

  @@id([auditCaseId, evidenceNodeId])
}

//////////////////////////////////////////////////////
// FIELD EXECUTION
//////////////////////////////////////////////////////

model WorkWindow {
  id             String   @id @default(uuid())
  organizationId String
  locationId     String
  startTime      DateTime
  endTime        DateTime
  status         WorkWindowStatus
}

enum WorkWindowStatus {
  approved
  denied
  overrun
}

model FieldLog {
  id           String   @id @default(uuid())
  workWindowId String
  employeeId   String
  weather      Json
  notes        String?
  createdAt    DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Restrict)
}

//////////////////////////////////////////////////////
// INCIDENTS & EMERGENCY
//////////////////////////////////////////////////////

model Incident {
  id             String   @id @default(uuid())
  organizationId String
  incidentType   String
  locationId     String
  occurredAt     DateTime
  severity       String

  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  employees    IncidentEmployee[]
  costs        IncidentCost[]
}

model IncidentEmployee {
  incidentId String
  employeeId String

  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Restrict)
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Restrict)

  @@id([incidentId, employeeId])
}

model IncidentCost {
  id         String   @id @default(uuid())
  incidentId String
  costType   CostType
  amount     Float
  createdAt  DateTime @default(now())

  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Restrict)
}

enum CostType {
  labor
  equipment
  material
}

//////////////////////////////////////////////////////
// ASSETS, DAMAGE, ENVIRONMENT
//////////////////////////////////////////////////////

model Asset {
  id             String   @id @default(uuid())
  organizationId String
  assetType      String
  identifier     String

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
}

model DamageReport {
  id          String   @id @default(uuid())
  assetId     String
  incidentId  String
  description String
  mediaId     String?
  createdAt   DateTime @default(now())
}

model EnvironmentalRecord {
  id         String   @id @default(uuid())
  incidentId String
  spillType  String
  reportedAt DateTime
}

//////////////////////////////////////////////////////
// LEGAL, INSURANCE, REGULATORS
//////////////////////////////////////////////////////

model InsurancePolicy {
  id             String   @id @default(uuid())
  organizationId String
  policyNumber   String
  coverageType   String
  expirationDate DateTime

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
}

model RegulatorSession {
  id             String   @id @default(uuid())
  organizationId String
  regulatorName  String
  accessStart    DateTime
  accessEnd      DateTime
}

//////////////////////////////////////////////////////
// LOCATION / GIS
//////////////////////////////////////////////////////

model Location {
  id          String   @id @default(uuid())
  subdivision String
  milepost    String
  latitude    Float
  longitude   Float

  verificationEvents VerificationEvent[]
}

//////////////////////////////////////////////////////
// AI LAYER (ADVISORY ONLY - NO ENFORCEMENT)
//////////////////////////////////////////////////////

model AIInsight {
  id            String   @id @default(uuid())
  insightType   String
  summary       String
  confidence    Float
  evidenceIds   String[] // references EvidenceNode IDs (no FK - read-only)
  createdAt     DateTime @default(now())

  @@index([insightType])
  @@index([createdAt])
}

model AISuggestion {
  id              String   @id @default(uuid())
  suggestionType  String
  description     String
  severity        String
  relatedEntity   String
  relatedEntityId String
  evidenceIds     String[] // references EvidenceNode IDs (no FK - read-only)
  createdAt       DateTime @default(now())

  @@index([suggestionType])
  @@index([relatedEntity, relatedEntityId])
  @@index([createdAt])
}

//////////////////////////////////////////////////////
// SUPPORT & SUBMISSIONS
//////////////////////////////////////////////////////

model ContactSubmission {
  id             String   @id @default(uuid())
  name           String
  email          String
  company        String?
  message        String
  organizationId String?
  submittedAt    DateTime @default(now())
  status         SubmissionStatus @default(new)
  assignedTo     String?
  
  @@index([status])
  @@index([submittedAt])
}

model DemoRequest {
  id             String   @id @default(uuid())
  name           String
  email          String
  company        String
  role           String?
  employeeCount  String?
  notes          String?
  organizationId String?
  submittedAt    DateTime @default(now())
  status         SubmissionStatus @default(new)
  
  @@index([status])
  @@index([submittedAt])
}

//////////////////////////////////////////////////////
// SLA & USAGE TRACKING
//////////////////////////////////////////////////////

model UptimeMetric {
  id              String   @id @default(uuid())
  organizationId  String
  month           String   // YYYY-MM format
  uptimePercent   Float
  downtimeMinutes Int
  slaCreditsEarned Float   @default(0)
  recordedAt      DateTime @default(now())
  
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@unique([organizationId, month])
  @@index([month])
}

model UsageMetric {
  id                  String   @id @default(uuid())
  organizationId      String
  metricType          UsageMetricType
  count               Int
  period              String   // YYYY-MM or YYYY for annual metrics
  exceededThreshold   Boolean  @default(false)
  flaggedAt           DateTime?
  recordedAt          DateTime @default(now())
  
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@unique([organizationId, metricType, period])
  @@index([metricType, period])
}

enum UsageMetricType {
  qr_scans_daily
  ai_events_annual
  employee_days_annual
  incidents_annual
}

enum SubmissionStatus {
  new
  contacted
  qualified
  demo_scheduled
  closed_won
  closed_lost
}
