generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////////
// CORE IDENTITY & ORGANIZATION
//////////////////////////////////////////////////////

model Organization {
  id        String   @id @default(uuid())
  name      String
  type      OrgType
  status    OrgStatus @default(active)
  createdAt DateTime @default(now())

  users       User[]
  employees   Employee[]
  crews       Crew[]
  incidents   Incident[]
  audits      AuditCase[]
  assets      Asset[]
  policies    InsurancePolicy[]
  workWindows WorkWindow[]
  jhas        JobHazardAnalysis[]
  nearMisses  NearMiss[]
}

enum OrgType {
  railroad
  contractor
  emergency
  municipality
}

enum OrgStatus {
  active
  inactive
}

model User {
  id             String   @id @default(uuid())
  organizationId String
  email          String   @unique
  role           UserRole
  status         UserStatus @default(active)
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
}

enum UserRole {
  admin
  safety
  dispatcher
  supervisor
  executive
}

enum UserStatus {
  active
  disabled
}

//////////////////////////////////////////////////////
// EMPLOYEES (FIELD PERSONNEL â€“ NOT USERS)
//////////////////////////////////////////////////////

model Employee {
  id             String   @id @default(uuid())
  organizationId String
  firstName      String
  lastName       String
  email          String?
  employeeNumber String?
  role           String?
  tradeRole      String
  photoMediaId   String?
  status         EmployeeStatus @default(active)
  hireDate       DateTime?
  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])
  certifications Certification[]
  crewMembers    CrewMember[]
  fieldLogs      FieldLog[]
  incidents      IncidentEmployee[]
  jhaAcknowledgments JHAAcknowledgment[]
}

enum EmployeeStatus {
  active
  inactive
}

//////////////////////////////////////////////////////
// CREWS
//////////////////////////////////////////////////////

model Crew {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  members      CrewMember[]
}

model CrewMember {
  crewId     String
  employeeId String

  crew     Crew     @relation(fields: [crewId], references: [id])
  employee Employee @relation(fields: [employeeId], references: [id])

  @@id([crewId, employeeId])
}

//////////////////////////////////////////////////////
// CERTIFICATIONS & QR VERIFICATION
//////////////////////////////////////////////////////

model Certification {
  id                 String   @id @default(uuid())
  employeeId         String
  certType           String
  certificationType  String
  issuingAuthority   String
  issueDate          DateTime
  expirationDate     DateTime?
  status             CertificationStatus
  certificateMediaId String?
  createdByUserId    String
  revokedAt          DateTime?
  revokedReason      String?
  createdAt          DateTime @default(now())

  employee   Employee @relation(fields: [employeeId], references: [id])
  qrTokens   VerificationToken[]
}

enum CertificationStatus {
  valid
  expiring
  expired
  revoked
}

model VerificationToken {
  id              String   @id @default(uuid())
  certificationId String
  token           String   @unique
  tokenHash       String   @unique
  status          TokenStatus @default(active)
  expiresAt       DateTime
  createdAt       DateTime @default(now())

  certification Certification @relation(fields: [certificationId], references: [id])
  scans         VerificationEvent[]
}

enum TokenStatus {
  active
  revoked
}

model VerificationEvent {
  id                  String   @id @default(uuid())
  verificationTokenId String
  verifiedAt          DateTime @default(now())
  verifiedBy          String?
  locationId          String?
  geoLat              Float?
  geoLong             Float?
  result              VerificationResult

  token VerificationToken @relation(fields: [verificationTokenId], references: [id])
  location Location? @relation(fields: [locationId], references: [id])
}

enum VerificationResult {
  valid
  expired
  revoked
}

//////////////////////////////////////////////////////
// EVIDENCE & IMMUTABLE LEDGER
//////////////////////////////////////////////////////

model EvidenceNode {
  id          String   @id @default(uuid())
  entityType  String
  entityId    String
  actorType   ActorType
  actorId     String
  timestamp   DateTime @default(now())
  createdAt   DateTime @default(now())
  locationId  String?
  hash        String   @default("")
  archived    Boolean  @default(false)
  archivedAt  DateTime?

  ledgerEntries ImmutableEventLedger[]
  auditCaseLinks AuditEvidenceLink[]
}

enum ActorType {
  user
  employee
  system
  regulator
}

model ImmutableEventLedger {
  id            String   @id @default(uuid())
  evidenceNodeId String
  eventType      String
  payload        Json
  createdAt      DateTime @default(now())
  compressed    Boolean  @default(false)

  evidenceNode EvidenceNode @relation(fields: [evidenceNodeId], references: [id])
}

//////////////////////////////////////////////////////
// SAFETY & COMPLIANCE
//////////////////////////////////////////////////////

model JobHazardAnalysis {
  id             String   @id @default(uuid())
  organizationId String
  jobName        String   @default("")
  workType       String
  locationId     String
  weather        Json
  status         JHAStatus
  createdAt      DateTime @default(now())

  organization    Organization @relation(fields: [organizationId], references: [id])
  acknowledgments JHAAcknowledgment[]
}

enum JHAStatus {
  draft
  active
  closed
}

model JHAAcknowledgment {
  id             String   @id @default(uuid())
  jhaId          String
  employeeId     String
  acknowledgedAt DateTime @default(now())

  jha      JobHazardAnalysis @relation(fields: [jhaId], references: [id])
  employee Employee          @relation(fields: [employeeId], references: [id])

  @@unique([jhaId, employeeId])
}

model AuditCase {
  id             String   @id @default(uuid())
  organizationId String
  title          String   @default("")
  description    String?
  auditType      AuditType
  status         AuditStatus
  createdAt      DateTime @default(now())

  organization  Organization @relation(fields: [organizationId], references: [id])
  evidenceLinks AuditEvidenceLink[]
}

enum AuditType {
  FRA
  OSHA
  internal
}

enum AuditStatus {
  open
  closed
}

model AuditEvidenceLink {
  id             String   @id @default(uuid())
  auditCaseId    String
  evidenceNodeId String

  auditCase    AuditCase    @relation(fields: [auditCaseId], references: [id])
  evidenceNode EvidenceNode @relation(fields: [evidenceNodeId], references: [id])

  @@unique([auditCaseId, evidenceNodeId])
}

//////////////////////////////////////////////////////
// FIELD EXECUTION
//////////////////////////////////////////////////////

model WorkWindow {
  id             String   @id @default(uuid())
  organizationId String
  name           String?
  locationId     String
  startTime      DateTime
  endTime        DateTime?
  status         WorkWindowStatus

  organization Organization @relation(fields: [organizationId], references: [id])
}

enum WorkWindowStatus {
  approved
  denied
  overrun
}

model FieldLog {
  id            String   @id @default(uuid())
  workWindowId  String
  employeeId    String
  weather       Json
  notes         String?
  loggedAt      DateTime @default(now())
  createdAt     DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id])
}

//////////////////////////////////////////////////////
// INCIDENTS & EMERGENCY
//////////////////////////////////////////////////////

model Incident {
  id             String   @id @default(uuid())
  organizationId String
  title          String   @default("")
  incidentType   String
  locationId     String
  occurredAt     DateTime
  severity       String
  status         String   @default("OPEN")

  organization Organization @relation(fields: [organizationId], references: [id])
  employees    IncidentEmployee[]
  costs        IncidentCost[]
}

model IncidentEmployee {
  id         String   @id @default(uuid())
  incidentId String
  employeeId String
  role       String?

  incident Incident @relation(fields: [incidentId], references: [id])
  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([incidentId, employeeId])
}

model IncidentCost {
  id          String   @id @default(uuid())
  incidentId  String
  costType    CostType
  amount      Float
  createdAt   DateTime @default(now())

  incident Incident @relation(fields: [incidentId], references: [id])
}

enum CostType {
  labor
  equipment
  material
}

//////////////////////////////////////////////////////
// ASSETS, DAMAGE, ENVIRONMENT
//////////////////////////////////////////////////////

model Asset {
  id             String   @id @default(uuid())
  organizationId String
  assetType      String
  identifier     String

  organization Organization @relation(fields: [organizationId], references: [id])
}

model DamageReport {
  id         String   @id @default(uuid())
  assetId    String
  incidentId String
  description String
  mediaId    String?
  createdAt  DateTime @default(now())
}

model EnvironmentalRecord {
  id          String   @id @default(uuid())
  incidentId  String
  spillType   String
  reportedAt  DateTime
}

//////////////////////////////////////////////////////
// LEGAL, INSURANCE, REGULATORS
//////////////////////////////////////////////////////

model InsurancePolicy {
  id             String   @id @default(uuid())
  organizationId String
  policyNumber   String
  coverageType   String
  expirationDate DateTime

  organization Organization @relation(fields: [organizationId], references: [id])
}

model RegulatorSession {
  id             String   @id @default(uuid())
  organizationId String
  regulatorName  String
  accessStart    DateTime
  accessEnd      DateTime
}

//////////////////////////////////////////////////////
// NEAR MISS REPORTING
//////////////////////////////////////////////////////

model NearMiss {
  id                   String   @id @default(uuid())
  organizationId       String
  title                String   @default("")
  description          String?
  category             String?
  severity             String?
  reportedAt           DateTime @default(now())
  reportedByEmployeeId String?
  reportedByUserId     String?
  location             String?
  createdAt            DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
}

//////////////////////////////////////////////////////
// LOCATION / GIS
//////////////////////////////////////////////////////

model Location {
  id          String   @id @default(uuid())
  subdivision String
  milepost    String
  latitude    Float
  longitude   Float

  verificationEvents VerificationEvent[]
}

//////////////////////////////////////////////////////
// ENFORCEMENT ACTIONS (APPEND-ONLY)
//////////////////////////////////////////////////////

model EnforcementAction {
  id            String           @id @default(uuid())
  actionType    EnforcementType
  targetType    String           // "employee" | "certification" | "jha" | "workWindow"
  targetId      String
  reason        String
  triggeredBy   String           // "system" | userId
  employeeId    String?
  certificationType String?
  action        String?          // "BLOCK" | "ALLOW"
  timestamp     DateTime         @default(now())
  createdAt     DateTime         @default(now())
}

enum EnforcementType {
  certification_block
  work_window_block
  jha_block
}

//////////////////////////////////////////////////////
// FATIGUE RISK FLAGS (HOURS-OF-SERVICE TRACKING)
//////////////////////////////////////////////////////

model FatigueRiskFlag {
  id             String   @id @default(uuid())
  employeeId     String
  hoursWorked    Float
  riskLevel      String   // "low" | "medium" | "high" | "critical"
  flaggedAt      DateTime @default(now())
  resolvedAt     DateTime?
  resolution     String?
  createdAt      DateTime @default(now())
}

